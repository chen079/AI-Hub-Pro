<!DOCTYPE html>
<html lang="zh-CN" :class="{ 'dark': isDarkMode }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hub Pro</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- 1. Tailwind CSS (带暗黑模式配置) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#1a1b1e',
                        darkcard: '#25262b',
                        darkinput: '#2c2e33',
                        darkborder: '#373a40'
                    }
                }
            }
        }
    </script>

    <!-- 2. FontAwesome 图标库 -->
    <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- 3. Highlight.js 代码高亮样式 (Atom One Dark) -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

    <!-- 4. 核心库预加载 -->
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.org/marked/9.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <!-- 5. 自定义样式 -->
    <link rel="stylesheet" href="/static/css/style.css?v=8">
</head>

<body
    class="bg-gray-100 text-gray-800 h-screen overflow-hidden dark:bg-darkbg dark:text-gray-200 transition-colors duration-300">

    <div id="app" class="h-full flex flex-col" v-cloak>
        <!-- ==================== 登录模态框 ==================== -->
        <div v-if="!isLoggedIn"
            class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm">
            <div
                class="bg-white dark:bg-darkcard p-8 rounded-xl shadow-2xl w-96 transform transition-all border border-gray-100 dark:border-darkborder">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-white tracking-wide">
                    <i class="fas fa-robot text-blue-500 mr-2"></i>AI Hub
                </h2>
                <div class="space-y-4">
                    <div>
                        <input v-model="authForm.username" type="text" :placeholder="t('username')"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition dark:bg-darkinput dark:border-darkborder dark:text-white dark:placeholder-gray-500">
                    </div>
                    <div>
                        <input v-model="authForm.password" type="password" :placeholder="t('password')"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition dark:bg-darkinput dark:border-darkborder dark:text-white dark:placeholder-gray-500">
                    </div>
                    <button @click="handleAuth"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">
                        [[ isRegistering ? t('register') : t('login') ]]
                    </button>
                </div>
                <div class="mt-6 flex justify-between items-center text-sm">
                    <span
                        class="text-gray-500 dark:text-gray-400 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 transition"
                        @click="isRegistering = !isRegistering">
                        [[ isRegistering ? t('has_acc') : t('create_acc') ]]
                    </span>
                </div>
                <p class="text-red-500 text-xs mt-4 text-center h-5 font-medium">[[ authError ]]</p>
            </div>
        </div>

        <!-- ==================== [新增] 系统提示词模态框 ==================== -->
        <div v-if="showSystemPromptModal" class="settings-modal-overlay" style="z-index: 260;"
            @click.self="showSystemPromptModal = false">
            <div
                class="settings-modal flex flex-col animate-fade-in-up bg-white dark:bg-darkcard dark:text-gray-200 w-[90%] max-w-lg overflow-hidden">

                <!-- 头部 -->
                <div
                    class="p-5 border-b dark:border-darkborder flex justify-between items-center bg-gray-50 dark:bg-darkinput">
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white text-lg flex items-center">
                            <i class="fas fa-user-cog mr-2 text-purple-500"></i>[[ t('sys_prompt_title') ]]
                        </h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">[[ t('sys_prompt_desc') ]]</p>
                    </div>
                    <button @click="showSystemPromptModal = false"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- 内容 -->
                <div class="p-6 space-y-4">
                    <!-- 预设快捷按钮 (可选) -->
                    <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                        <button @click="settings.system_prompt = 'You are a helpful assistant.'"
                            class="px-3 py-1 text-xs rounded-full border border-gray-200 dark:border-gray-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 transition whitespace-nowrap">
                            [[ t('default_assistant') ]]
                        </button>
                        <button @click="settings.system_prompt = '你是一个精通 Python 和 Vue 的全栈工程师，回答要专业且代码要写注释。'"
                            class="px-3 py-1 text-xs rounded-full border border-gray-200 dark:border-gray-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 transition whitespace-nowrap">
                            [[ t('fullstack_expert') ]]
                        </button>
                        <button @click="settings.system_prompt = '你是一个资深翻译，请将我输入的内容翻译成优雅的中文。'"
                            class="px-3 py-1 text-xs rounded-full border border-gray-200 dark:border-gray-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 transition whitespace-nowrap">
                            [[ t('translator') ]]
                        </button>
                        <button @click="settings.system_prompt = '请用苏格拉底式的教学方法，通过提问引导我思考，而不是直接给出答案。'"
                            class="px-3 py-1 text-xs rounded-full border border-gray-200 dark:border-gray-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 transition whitespace-nowrap">
                            [[ t('socratic') ]]
                        </button>
                    </div>

                    <!-- 输入框 -->
                    <div class="relative">
                        <textarea v-model="settings.system_prompt" rows="8"
                            class="w-full p-4 rounded-xl border border-gray-200 dark:border-darkborder bg-gray-50 dark:bg-darkinput focus:ring-2 focus:ring-purple-500 outline-none text-sm leading-relaxed dark:text-gray-200 resize-none"
                            :placeholder="t('sys_prompt_placeholder')"></textarea>

                        <!-- 清空按钮 -->
                        <button v-if="settings.system_prompt" @click="settings.system_prompt = ''"
                            class="absolute bottom-3 right-3 text-xs text-gray-400 hover:text-red-500 transition">
                            [[ t('clear') ]]
                        </button>
                    </div>
                </div>

                <!-- 底部 -->
                <div class="p-5 border-t dark:border-darkborder bg-gray-50 dark:bg-darkinput flex justify-end">
                    <button @click="showSystemPromptModal = false"
                        class="mr-3 px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition">[[
                        t('cancel') ]]</button>
                    <button @click="saveSystemPrompt"
                        class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg shadow-sm transition transform active:scale-95">
                        [[ t('save_settings') ]]
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== 设置模态框 ==================== -->
        <div v-if="showSettings" class="settings-modal-overlay" @click.self="toggleSettings">
            <div class="settings-modal flex flex-col animate-fade-in-up bg-white dark:bg-darkcard dark:text-gray-200">
                <div
                    class="p-4 border-b dark:border-darkborder flex justify-between items-center bg-gray-50 dark:bg-darkcard rounded-t-xl">
                    <h3 class="font-bold text-gray-800 dark:text-white text-lg flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-blue-500"></i>[[ t('settings') ]]
                    </h3>
                    <button @click="toggleSettings"
                        class="w-8 h-8 rounded-full hover:bg-gray-200 dark:hover:bg-darkinput text-gray-500 transition flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">

                    <!-- 暗黑模式开关 -->
                    <div
                        class="flex items-center justify-between bg-gray-50 dark:bg-darkinput p-3 rounded-lg border border-gray-200 dark:border-darkborder">
                        <span class="font-semibold text-sm text-gray-700 dark:text-gray-200"><i
                                class="fas fa-moon mr-2"></i>[[ t('dark_mode') ]]</span>
                        <button @click="toggleDarkMode"
                            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
                            :class="isDarkMode ? 'bg-blue-600' : 'bg-gray-300'">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                                :class="isDarkMode ? 'translate-x-6' : 'translate-x-1'"></span>
                        </button>
                    </div>

                    <!-- API Endpoint -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">[[
                            t('api_endpoint') ]]</label>
                        <input v-model="settings.api_endpoint" type="text"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm dark:bg-darkinput dark:border-darkborder dark:text-white">
                    </div>

                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">[[ t('api_key')
                            ]]<span v-if="settings.api_key && settings.api_key.includes('***')"
                                class="text-xs text-green-500 font-normal ml-2">[[ t('encrypted') ]]</span>
                        </label>
                        <input v-model="settings.api_key" type="password" placeholder="sk-..."
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm dark:bg-darkinput dark:border-darkborder dark:text-white">
                    </div>

                    <!-- 模型选择 -->
                    <div
                        class="bg-gray-50 dark:bg-darkinput p-3 rounded-lg border border-gray-200 dark:border-darkborder">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">[[
                                t('model_select') ]]</label>
                            <div class="space-x-3 text-xs">
                                <!-- 概览按钮 -->
                                <button @click="showModelOverview = true"
                                    class="text-purple-600 dark:text-purple-400 hover:text-purple-800 font-medium transition">
                                    <i class="fas fa-th-large"></i> [[ t('model_overview') ]]
                                </button>
                                <!-- 刷新按钮 -->
                                <button @click="fetchModels()"
                                    class="text-green-600 dark:text-green-400 hover:text-green-800 font-medium transition">
                                    <i class="fas fa-sync-alt" :class="{'fa-spin': isLoadingModels}"></i> [[
                                    t('refresh') ]]
                                </button>
                                <!-- 切换按钮 -->
                                <button @click="useCustomModel = !useCustomModel"
                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 font-medium underline">
                                    [[ useCustomModel ? t('switch_list') : t('manual_input') ]]
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <!-- 模式A: 下拉列表 -->
                            <select v-if="!useCustomModel" v-model="settings.model"
                                class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none text-sm appearance-none dark:text-white">
                                <option value="" disabled>[[ t("pmodel_select") ]]</option>
                                <option v-for="m in modelList" :value="m">[[ m ]]</option>
                            </select>
                            <i v-if="!useCustomModel"
                                class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 pointer-events-none text-xs"></i>

                            <!-- 模式B: 手动输入框 -->
                            <input v-else v-model="settings.model" type="text"
                                class="w-full p-2.5 border border-blue-300 dark:border-blue-800 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-blue-50 dark:bg-gray-800 dark:text-white"
                                :placeholder="t('model_placeholder_manual')">
                        </div>
                    </div>
                    <!-- 【新增】上下文长度控制 -->
                    <div
                        class="bg-gray-50 dark:bg-darkinput p-3 rounded-lg border border-gray-200 dark:border-darkborder">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                                <i class="fas fa-history mr-1 text-gray-400"></i> [[ t("context_len") ]]
                            </label>
                            <span
                                class="text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded">
                                [[ settings.context_length ]]
                            </span>
                        </div>

                        <!-- 滑块: 范围 0 - 60, 步长 2 (保持一问一答的完整性) -->
                        <div class="relative pt-1">
                            <input type="range" v-model.number="settings.context_length" min="0" max="60" step="2"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600">
                        </div>

                        <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                            <span>[[ t('context_desc_1') ]]</span>
                            <span>[[ t('context_desc_2') ]]</span>
                            <span>[[ t('context_desc_3') ]]</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">
                            [[ t('context_tip') ]]
                        </p>
                    </div>
                    <!-- === 新增：自定义 API 适配 === -->
                    <div class="border border-gray-200 dark:border-darkborder rounded-lg overflow-hidden">
                        <button @click="showAdvancedApi = !showAdvancedApi"
                            class="w-full flex justify-between items-center p-3 bg-gray-100 dark:bg-darkinput text-xs font-bold text-gray-700 dark:text-gray-300">
                            <span><i class="fas fa-code-branch mr-2"></i>[[ t('custom_api_btn') ]]</span>
                            <i class="fas" :class="showAdvancedApi ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>

                        <div v-show="showAdvancedApi"
                            class="p-4 bg-white dark:bg-darkcard space-y-4 text-sm animate-fade-in-up">

                            <div
                                class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded text-xs text-blue-600 dark:text-blue-300 mb-2">
                                [[ t('custom_api_tip') ]]<br>
                                <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">"{{MESSAGES}}"</code>
                                <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">"{{MODEL}}"</code>
                            </div>

                            <!-- 请求体模板 -->
                            <div>
                                <label class="block font-semibold mb-1 text-gray-600 dark:text-gray-400">Request JSON
                                    Template</label>
                                <textarea v-model="settings.custom_request_template" rows="6"
                                    class="w-full p-2 font-mono text-xs border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-darkinput dark:text-gray-300 outline-none focus:border-blue-500"
                                    placeholder='Default (OpenAI):
{
"model": "{{MODEL}}",
"messages": "{{MESSAGES}}",
"stream": true,
"temperature": 0.7
}'></textarea>
                            </div>

                            <!-- 响应提取路径 -->
                            <div>
                                <label class="block font-semibold mb-1 text-gray-600 dark:text-gray-400">Response Data
                                    Path</label>
                                <input v-model="settings.custom_response_path" type="text"
                                    class="w-full p-2 font-mono text-xs border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-darkinput dark:text-gray-300 outline-none focus:border-blue-500"
                                    placeholder="Default: choices[0].delta.content">
                                <p class="text-xs text-gray-400 mt-1">Gemini: <code
                                        class="bg-gray-100 dark:bg-gray-700 px-1">candidates[0].content.parts[0].text</code>
                                </p>
                            </div>

                            <button @click="resetApiSettings" class="text-xs text-red-500 hover:underline">[[
                                t('restore_default') ]]</button>
                        </div>
                    </div>
                    <!-- 用户头像 -->
                    <div
                        class="bg-gray-50 dark:bg-darkinput p-3 rounded-lg border border-gray-200 dark:border-darkborder flex items-center justify-between">
                        <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">[[
                                t('user_avatar')]]</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400">[[ t('click_upload')]]</p>
                        </div>
                        <div class="relative cursor-pointer group" @click="triggerAvatarUpload">
                            <div v-if="settings.user_avatar"
                                class="w-12 h-12 rounded-full shadow-md bg-cover bg-center border-2 border-white dark:border-gray-600"
                                :style="{backgroundImage: 'url(' + settings.user_avatar + ')'}"></div>
                            <div v-else
                                class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white shadow-md border-2 border-white dark:border-gray-600">
                                <i class="fas fa-user"></i>
                            </div>
                            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*"
                                @change="handleAvatarSelect">
                        </div>
                    </div>

                    <!-- 按钮组 -->
                    <div class="pt-4 border-t dark:border-darkborder flex space-x-3">

                        <!-- [新增] 测试连接按钮 -->
                        <button @click="handleTestConnection"
                            class="px-4 py-2.5 rounded-lg font-medium transition shadow-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center min-w-[110px]"
                            :disabled="isTestingConnection">
                            <!-- 图标：根据状态显示 插头 或 转圈圈 -->
                            <i class="fas mr-2" :class="isTestingConnection ? 'fa-spinner fa-spin' : 'fa-plug'"></i>
                            [[ isTestingConnection ? t('test_conning') : t('test_conn') ]]
                        </button>

                        <!-- 原有的保存按钮 -->
                        <button @click="saveSettings"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg font-medium transition shadow-sm flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> [[ t('save') ]]
                        </button>
                    </div>
                    <div class="text-center pt-2">
                        <button @click="logout"
                            class="text-red-500 hover:text-red-700 dark:text-red-400 text-sm font-medium transition">[[
                            t('logout') ]]</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== [新增] 充值/点数 模态框 ==================== -->
        <div v-if="showTopUpModal" class="settings-modal-overlay" style="z-index: 250;"
            @click.self="showTopUpModal = false">
            <div
                class="settings-modal flex flex-col animate-fade-in-up bg-white dark:bg-darkcard dark:text-gray-200 w-[90%] max-w-sm overflow-hidden">

                <!-- 头部 -->
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 p-6 text-white relative">
                    <button @click="showTopUpModal = false"
                        class="absolute top-4 right-4 text-white/80 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <div class="text-sm font-medium opacity-90 mb-1">[[t('balance_title')]]</div>
                    <div class="text-4xl font-bold flex items-baseline">
                        <i class="fas fa-coins mr-2 text-2xl"></i> [[ userPoints ]]
                    </div>
                </div>

                <!-- 套餐列表 -->
                <div class="p-6 space-y-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">[[t('topup_select')]]</p>

                    <div class="grid grid-cols-1 gap-3">
                        <button v-for="opt in topUpOptions" :key="opt.price" @click="handleTopUp(opt.points)"
                            class="flex justify-between items-center p-4 rounded-xl border-2 border-gray-100 dark:border-gray-700 hover:border-yellow-400 dark:hover:border-yellow-500 bg-white dark:bg-darkinput transition group">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-400 group-hover:scale-110 transition">
                                    <i class="fas fa-gem"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-bold text-gray-800 dark:text-gray-200">[[ opt.points ]] 点</div>
                                    <div class="text-xs text-gray-400">[[ opt.label ]]</div>
                                </div>
                            </div>
                            <div class="text-lg font-bold text-blue-600 dark:text-blue-400">[[ opt.price ]]</div>
                        </button>
                    </div>
                </div>

                <div
                    class="p-4 bg-gray-50 dark:bg-darkinput border-t dark:border-darkborder text-center text-xs text-gray-400">
                    [[t('demo_tip')]]
                </div>
            </div>
        </div>

        <!-- ==================== [新增] 关于/版权模态框 ==================== -->
        <div v-if="showAbout" class="settings-modal-overlay" style="z-index: 300;" @click.self="showAbout = false">
            <div
                class="settings-modal flex flex-col animate-fade-in-up bg-white dark:bg-darkcard dark:text-gray-200 overflow-hidden w-[90%] max-w-md">

                <!-- 头部 -->
                <div class="p-6 pb-0 flex justify-between items-start">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg shadow-blue-500/30">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">AI Hub Pro</h2>
                            <p class="text-xs text-gray-500 dark:text-gray-400 font-mono">v1.0.0 Stable</p>
                        </div>
                    </div>
                    <button @click="showAbout = false"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- 内容区域 -->
                <div class="p-6 space-y-6 text-sm">
                    <p class="text-gray-600 dark:text-gray-300 leading-relaxed">
                        [[t('about_desc')]]
                    </p>

                    <!-- 链接组 -->
                    <div class="grid grid-cols-2 gap-3">
                        <a href="https://github.com/chen079/AI-Hub-Pro" target="_blank"
                            class="flex items-center justify-center gap-2 p-3 bg-gray-50 dark:bg-darkinput rounded-lg border border-gray-200 dark:border-darkborder hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 hover:shadow-md transition-all duration-200 group">

                            <!-- 图标：悬停变蓝 + 微微放大 -->
                            <i
                                class="fab fa-github text-xl group-hover:text-blue-600 group-hover:scale-110 transition-transform duration-200"></i>

                            <!-- 文字：悬停变蓝 -->
                            <span
                                class="font-medium group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">GitHub</span>
                        </a>
                        <a href="/static/docs.html" target="_blank"
                            class="flex items-center justify-center gap-2 p-3 bg-gray-50 dark:bg-darkinput rounded-lg border border-gray-200 dark:border-darkborder hover:border-green-500 hover:bg-green-50 dark:hover:bg-green-900/10 hover:shadow-md transition-all duration-200 group">

                            <!-- 图标：增加一点缩放动画 -->
                            <i
                                class="fas fa-book text-xl text-green-600 group-hover:scale-110 transition-transform duration-200"></i>

                            <!-- 文字：悬停时变绿 -->
                            <span
                                class="font-medium group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">[[t('docs')]]</span>
                        </a>
                    </div>

                    <!-- 版权声明 -->
                    <div
                        class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800/30">
                        <h4 class="font-bold text-blue-800 dark:text-blue-300 mb-1 flex items-center">
                            <i class="fas fa-balance-scale mr-2"></i> MIT License
                        </h4>
                        <p class="text-xs text-blue-600 dark:text-blue-400 leading-relaxed">
                            [[ t('license_desc') ]]
                            <br>
                            Copyright &copy; 2025 AI Hub Pro.
                        </p>
                    </div>

                    <!-- 技术栈徽章 -->
                    <div
                        class="flex flex-wrap gap-2 justify-center opacity-70 grayscale hover:grayscale-0 transition-all duration-500">
                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Flask</span>
                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Vue 3</span>
                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Tailwind</span>
                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">SQLite</span>
                    </div>
                </div>

                <!-- 底部 -->
                <div
                    class="p-4 bg-gray-50 dark:bg-darkinput text-center text-xs text-gray-400 border-t dark:border-darkborder">
                    [[t('made_with')]] <i class="fas fa-heart text-red-500 animate-pulse"></i> by Charlin
                </div>
            </div>
        </div>

        <!-- 模型概览模态框 (黑夜模式适配版) -->
        <div v-if="showModelOverview" style="z-index: 200;"
            class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-95 backdrop-blur-sm animate-fade-in-up">

            <!-- 修改点 1: 容器背景 bg-gray-50 -> dark:bg-gray-900 -->
            <div
                class="bg-gray-50 dark:bg-gray-900 w-full h-full md:w-5/6 md:h-5/6 md:rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">

                <!-- 1. 标题栏与搜索 -->
                <!-- 修改点 2: 标题栏背景 bg-white -> dark:bg-gray-800, 边框 dark:border-gray-700 -->
                <div
                    class="p-5 bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex justify-between items-center shadow-sm z-10">
                    <div>
                        <!-- 标题文字颜色 -->
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-layer-group text-blue-500 mr-2"></i>[[t('model_lib_title')]]
                        </h2>
                        <!-- 副标题文字颜色 -->
                        <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">
                            [[ formatString(t('model_lib_desc'), modelList.length) ]]
                        </p>
                    </div>

                    <!-- 搜索框 -->
                    <div class="flex-1 mx-8 max-w-xl">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <!-- 修改点 3: 搜索输入框背景、边框、文字 -->
                            <input v-model="modelSearchQuery" type="text"
                                class="w-full pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition dark:text-white dark:placeholder-gray-400"
                                :placeholder="t('search_placeholder')">
                        </div>
                    </div>

                    <!-- 关闭按钮 -->
                    <button @click="showModelOverview = false"
                        class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 hover:text-red-500 transition flex items-center justify-center text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- 2. 内容区域 -->
                <!-- 修改点 4: 滚动区背景 bg-gray-50 -> dark:bg-gray-900 -->
                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-gray-50 dark:bg-gray-900">
                    <div class="masonry-columns">

                        <!-- 循环渲染分组 -->
                        <!-- 修改点 5: 卡片背景 bg-white -> dark:bg-gray-800, 边框 dark:border-gray-700 -->
                        <div v-for="(models, provider) in groupedModels" :key="provider"
                            class="break-inside-avoid mb-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300 overflow-hidden flex flex-col">

                            <!-- 分组头部 -->
                            <!-- 修改点 6: 头部背景变深，文字变白 -->
                            <div
                                class="p-4 bg-gray-50/50 dark:bg-gray-700/50 border-b border-gray-100 dark:border-gray-700 flex items-center space-x-3">
                                <div
                                    class="w-10 h-10 bg-white dark:bg-gray-200 rounded-lg shadow-sm border dark:border-gray-300 p-1.5 flex-shrink-0 flex items-center justify-center">
                                    <img :src="getModelAvatar(provider)" @error="handleImageError"
                                        class="w-full h-full object-contain">
                                </div>
                                <h3 class="font-bold text-gray-700 dark:text-gray-200 capitalize text-lg">[[ provider ]]
                                </h3>
                            </div>

                            <!-- 模型列表 Tag -->
                            <div class="p-4 flex flex-wrap gap-2">
                                <!-- 修改点 7: 按钮未选中状态适配黑夜模式 -->
                                <button v-for="m in models" @click="selectModelFromOverview(m)"
                                    class="px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200 text-left hover:scale-105 active:scale-95"
                                    :class="settings.model === m ? 
                                'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-200 dark:ring-blue-900' : 
                                'bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-600 hover:bg-white dark:hover:bg-gray-600 hover:border-blue-300 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400'">
                                    [[ m ]]
                                    <i v-if="settings.model === m" class="fas fa-check ml-1 text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 空状态提示 -->
                    <div v-if="Object.keys(groupedModels).length === 0"
                        class="h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 py-20">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>[[t('no_model_found')]]</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 主界面 ==================== -->
        <div v-if="isLoggedIn" class="flex flex-1 h-full w-full relative">

            <!-- 左侧边栏 -->
            <!-- 左侧边栏 -->
            <div class="bg-gray-50 dark:bg-darkcard dark:border-darkborder flex flex-col shadow-lg z-20 transition-all duration-300 flex-shrink-0 border-gray-200"
                :class="showSidebar ? 'w-64 translate-x-0 border-r' : 'w-0 -translate-x-full border-none md:w-0 md:translate-x-0 overflow-hidden'">

                <div class="p-4 flex justify-between items-center flex-shrink-0 h-16 border-b dark:border-darkborder">
                    <button @click="startNewChat"
                        class="bg-white dark:bg-darkinput dark:text-white dark:border-darkborder hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 py-2 px-4 rounded-lg text-sm transition flex items-center shadow-sm font-medium border border-gray-200 w-full justify-center">
                        <i class="fas fa-plus mr-2 text-blue-500"></i> [[ t('new_chat') ]]
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                    <div class="text-xs text-gray-400 font-medium px-3 py-2">[[ t('history') ]]</div>
                    <!-- 侧边栏历史记录循环 -->
                    <div v-for="session in sessions" :key="session.id" @click="selectSession(session.id)"
                        class="session-item p-3 rounded-lg cursor-pointer flex justify-between items-center group transition"
                        :class="currentSessionId === session.id ? 'bg-gray-200 dark:bg-blue-900 dark:text-white text-gray-900 font-medium' : 'hover:bg-gray-200 dark:hover:bg-darkinput text-gray-600 dark:text-gray-300'">

                        <div class="truncate text-sm flex-1 pr-2">[[ session.title || '新对话' ]]</div>

                        <!-- 这里的 session-actions 默认是不显示的(opacity-0)，鼠标悬停(group-hover)才显示 -->
                        <div
                            class="session-actions flex items-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">

                            <!-- [新增] 重命名按钮 -->
                            <button @click.stop="renameSession(session.id)" title="重命名"
                                class="p-1.5 mr-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition">
                                <i class="fas fa-pen"></i>
                            </button>

                            <!-- 原有的 删除按钮 -->
                            <button @click.stop="deleteSession(session.id)" title="删除"
                                class="p-1.5 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition">
                                <i class="fas fa-trash"></i>
                            </button>

                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-200 dark:border-darkborder">
                    <div class="flex items-center justify-between">

                        <!-- 左侧：用户信息 (点击头像或名字也可以打开设置) -->
                        <div @click="toggleSettings"
                            class="flex items-center cursor-pointer group overflow-hidden mr-2">
                            <!-- 头像 -->
                            <div
                                class="w-8 h-8 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center text-white text-xs overflow-hidden border border-gray-300 dark:border-gray-600">
                                <img v-if="settings.user_avatar" :src="settings.user_avatar"
                                    class="w-full h-full object-cover">
                                <i v-else class="fas fa-user"></i>
                            </div>
                            <!-- 用户名 -->
                            <div
                                class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-200 truncate group-hover:text-blue-600 transition max-w-[90px]">
                                [[ authForm.username ]]
                            </div>
                        </div>

                        <!-- 右侧：图标按钮组 -->
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <!-- 设置按钮 -->
                            <button @click="toggleLang"
                                class="w-8 h-8 rounded-lg text-gray-400 hover:text-blue-600 dark:hover:bg-darkinput transition font-bold text-xs">[[
                                lang === 'zh' ? 'En' : '中' ]]</button> <button @click="toggleSettings"
                                :title="t('settings')"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-blue-600 hover:bg-gray-100 dark:hover:bg-darkinput transition">
                                <i class="fas fa-cog"></i>
                            </button>

                            <!-- 关于按钮 -->
                            <button @click="showAbout = true" :title="t('about_title')"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-blue-600 hover:bg-gray-100 dark:hover:bg-darkinput transition">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="flex-1 flex flex-col bg-white dark:bg-darkbg relative overflow-hidden w-full">

                <!-- 修改为 (增加 text-gray-600 并确保 z-index 够高) -->
                <div class="absolute top-4 left-4 z-[40] md:hidden" v-if="!showSidebar">
                    <button @click="showSidebar = !showSidebar"
                        class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white p-2 rounded-lg bg-white/80 dark:bg-black/40 backdrop-blur-md shadow-sm border border-gray-200 dark:border-gray-700">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>

                <!-- ================================================== -->
                <!-- 场景 1: 欢迎页 (New Chat Mode) -->
                <!-- ================================================== -->
                <div v-if="isNewChatMode"
                    class="flex-1 flex flex-col items-center justify-center p-4 relative w-full h-full">

                    <!-- [修正] 右上角悬浮点数 (仅在付费模式显示) -->
                    <div v-if="paidMode" class="absolute top-4 right-4 z-20">
                        <div @click="showTopUpModal = true"
                            class="cursor-pointer group flex items-center gap-2 bg-yellow-50 dark:bg-yellow-900/20 px-3 py-1.5 rounded-full border border-yellow-200 dark:border-yellow-700/50 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition shadow-sm">
                            <i class="fas fa-coins text-yellow-500 animate-pulse"></i>
                            <span class="text-sm font-bold text-yellow-700 dark:text-yellow-400">[[ userPoints ]]</span>
                            <i
                                class="fas fa-plus-circle text-xs text-yellow-400 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>

                    <div class="w-full max-w-2xl flex flex-col items-center animate-fade-in-up z-10">
                        <!-- Logo 与 标题 -->
                        <div class="mb-10 text-center">
                            <div
                                class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 mb-4 tracking-tight">
                                AI Hub Pro
                            </div>
                            <!-- 当前模型指示器 -->
                            <div class="flex items-center gap-3 mt-2">
                                <!-- 当前模型指示器 -->
                                <div
                                    class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-gray-100 dark:bg-darkinput border border-gray-200 dark:border-darkborder text-sm text-gray-600 dark:text-gray-300">
                                    <img :src="getModelAvatar(settings.model)" class="w-4 h-4 rounded-full">
                                    <span>[[ settings.model ]]</span>
                                </div>

                                <!-- 【新增】系统提示词按钮 -->
                                <button @click="showSystemPromptModal = true"
                                    class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white dark:bg-darkinput border border-purple-200 dark:border-purple-900/50 text-purple-600 dark:text-purple-400 text-sm hover:bg-purple-50 dark:hover:bg-purple-900/20 transition shadow-sm"
                                    title="设置 AI 人设">
                                    <i class="fas fa-user-cog"></i>
                                    <span>[[ settings.system_prompt ? t('sysrole_set') : t('sysrole_unset') ]]</span>
                                </button>
                            </div>
                        </div>

                        <!-- 居中大输入框 -->
                        <div
                            class="w-full relative shadow-2xl shadow-blue-900/10 dark:shadow-none rounded-2xl border border-gray-200 dark:border-darkborder bg-white dark:bg-darkinput focus-within:ring-2 focus-within:ring-blue-500 transition-all overflow-hidden">
                            <textarea v-model="inputMessage" @keydown.enter.prevent="!isThinking ? sendMessage() : null"
                                class="w-full py-5 pl-6 pr-14 rounded-2xl outline-none resize-none text-gray-700 dark:text-gray-200 placeholder-gray-400 min-h-[80px] max-h-[200px] overflow-hidden bg-transparent text-lg"
                                :placeholder="t('input_placeholder')" rows="1"></textarea>

                            <!-- 修改这里：底部工具栏 -->
                            <div class="flex justify-between items-center px-4 pb-3 bg-gray-50/50 dark:bg-black/10">

                                <!-- 左侧：功能按钮组 -->
                                <div class="flex items-center gap-3">
                                    <!-- [恢复] 深度思考按钮 -->
                                    <button @click="toggleDeepThinking"
                                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all border select-none group"
                                        :class="isDeepThinkingEnabled ? 
                    'bg-blue-100 text-blue-600 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-700/50 shadow-sm' : 
                    'bg-white dark:bg-gray-700/50 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600'">
                                        <i class="fas fa-brain" :class="{'animate-pulse': isDeepThinkingEnabled}"></i>
                                        <span>[[ t('deep_think_btn') ]]</span>
                                        <!-- R1/O1 标识 (可选) -->
                                        <span v-if="isDeepThinkingEnabled"
                                            class="ml-1 text-[10px] opacity-70 bg-blue-200 dark:bg-blue-800 px-1 rounded">R1</span>
                                    </button>

                                    <!-- 附件按钮 -->
                                    <button @click="triggerFileUpload"
                                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all border border-transparent hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                </div>

                                <!-- 右侧：发送按钮 -->
                                <button @click="sendMessage" :disabled="!inputMessage && attachedFiles.length===0"
                                    class="w-10 h-10 rounded-xl flex items-center justify-center transition shadow-lg"
                                    :class="(inputMessage || attachedFiles.length>0) ? 'bg-blue-600 text-white hover:bg-blue-700 hover:scale-105' : 'bg-gray-200 dark:bg-gray-700 text-gray-400 cursor-not-allowed'">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                            </div>

                            <!-- 文件预览 -->
                            <div v-if="attachedFiles.length > 0"
                                class="px-4 pb-2 flex gap-2 overflow-x-auto bg-gray-50 dark:bg-black/20">
                                <div v-for="(file, idx) in attachedFiles" :key="idx" class="relative group">
                                    <img v-if="file.type==='image'" :src="file.content"
                                        class="h-10 w-10 rounded object-cover border dark:border-gray-600">
                                    <div v-else
                                        class="h-10 w-10 flex items-center justify-center bg-white dark:bg-gray-700 rounded border dark:border-gray-600 text-gray-500">
                                        <i class="fas fa-file"></i>
                                    </div>
                                    <button @click="removeFile(idx)"
                                        class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100">&times;</button>
                                </div>
                            </div>
                        </div>

                        <!-- 底部推荐 (移动端隐藏，保持极简) -->
                        <div class="mt-8 w-full px-2 hidden md:block opacity-80 hover:opacity-100 transition-opacity">
                            <div class="flex justify-between items-center mb-3 px-1">
                                <span
                                    class="text-xs font-medium text-gray-400 uppercase tracking-wider">[[t('try_it')]]</span>
                                <button @click="refreshRandomPrompts"
                                    class="text-xs text-blue-500 hover:text-blue-600 transition flex items-center gap-1">
                                    <i class="fas fa-sync-alt"></i> [[t('change_batch')]]
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button v-for="(item, index) in randomPrompts" :key="index"
                                    @click="inputMessage=item.content; sendMessage()"
                                    class="text-left p-3 rounded-xl border border-gray-200 dark:border-darkborder bg-white dark:bg-darkinput hover:bg-gray-50 dark:hover:bg-gray-700 hover:shadow-md transition h-full flex flex-col">
                                    <div
                                        class="font-bold text-gray-700 dark:text-gray-200 text-sm mb-1 flex items-center gap-2">
                                        <span>[[ item.icon ]]</span> [[ item.title ]]
                                    </div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">[[ item.content
                                        ]]</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================================================== -->
                <!-- 场景 2: 聊天模式 (Active Chat Mode) -->
                <!-- ================================================== -->
                <div v-else class="flex-1 flex flex-col h-full w-full">
                    <!-- 顶部栏 (只在聊天模式显示) -->
                    <div class="h-14 border-b dark:border-darkborder flex items-center justify-between bg-white/80 dark:bg-darkbg/90 backdrop-blur z-10 transition-all"
                        :class="!showSidebar ? 'pl-14 pr-4' : 'px-4'">

                        <div class="flex items-center text-gray-700 dark:text-white font-medium truncate max-w-[50%]">
                            <span>[[ currentSessionTitle ]]</span>
                        </div>

                        <!-- 【新增】Token 计数器 -->
                        <div class="hidden md:flex items-center gap-1.5 px-3 py-1 bg-gray-100 dark:bg-darkinput rounded-full border border-gray-200 dark:border-darkborder text-xs text-gray-500 dark:text-gray-400"
                            title="当前会话估算 Token 消耗">
                            <i class="fas fa-calculator text-gray-400"></i>
                            <span class="font-mono">[[ totalSessionTokens ]] tkns</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- 【新增】系统提示词按钮 -->
                            <button @click="showSystemPromptModal = true"
                                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-blue-600 hover:bg-gray-100 dark:hover:bg-darkinput transition hidden md:flex"
                                title="设置 AI 人设">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            <div v-if="paidMode" @click="showTopUpModal = true"
                                class="cursor-pointer group flex items-center gap-2 bg-yellow-50 dark:bg-yellow-900/20 px-3 py-1.5 rounded-full border border-yellow-200 dark:border-yellow-700/50 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition">
                                <i class="fas fa-coins text-yellow-500"></i>
                                <span class="text-sm font-bold text-yellow-700 dark:text-yellow-400">[[ userPoints
                                    ]]</span>
                            </div>
                            <div class="text-xs text-gray-400 flex items-center gap-2 hidden md:flex">
                                <img :src="getModelAvatar(settings.model)"
                                    class="w-4 h-4 rounded-full bg-gray-100 dark:bg-gray-700 p-0.5">
                                [[ settings.model ]]
                            </div>
                        </div>
                    </div>

                    <!-- 消息滚动区 -->
                    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth" id="chat-container"
                        @scroll="handleScroll">
                        <div v-for="(msg, index) in messages" :key="index"
                            class="flex flex-col w-full animate-fade-in max-w-4xl mx-auto group mb-6"
                            :class="msg.role === 'user' ? 'items-end' : 'items-start'">

                            <div class="text-xs text-gray-400 mb-1 px-1 select-none">
                                [[ msg.role === 'user' ? authForm.username : (msg.model || 'AI') ]]
                            </div>

                            <div class="flex w-full max-w-[95%] md:max-w-[85%]"
                                :class="msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'">
                                <!-- 头像 -->
                                <div
                                    class="w-9 h-9 rounded-full flex-shrink-0 overflow-hidden flex items-center justify-center border border-gray-100 dark:border-gray-700 bg-white dark:bg-darkinput shadow-sm mx-2 p-1">
                                    <template v-if="msg.role === 'user'">
                                        <img v-if="settings.user_avatar" :src="settings.user_avatar"
                                            class="w-full h-full object-cover rounded-full">
                                        <div v-else
                                            class="w-full h-full bg-blue-500 rounded-full flex items-center justify-center text-white">
                                            <i class="fas fa-user text-xs"></i>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <img :src="getModelAvatar(msg.model)" class="w-full h-full object-contain">
                                    </template>
                                </div>

                                <!-- 气泡 -->
                                <div class="text-sm md:text-base leading-relaxed overflow-hidden pt-1 min-w-[60px]">
                                    <div v-if="msg.role === 'user'"
                                        class="bg-blue-600 text-white px-4 py-2.5 rounded-2xl rounded-tr-sm whitespace-pre-wrap shadow-sm inline-block text-left">
                                        <div v-if="msg.files && msg.files.length > 0" class="flex flex-col gap-2 mb-2">
                                            <div v-for="(f, fIdx) in msg.files" :key="fIdx">
                                                <img v-if="f.type==='image'" :src="f.content"
                                                    class="chat-image-preview border-white/20">
                                                <!-- 修改开始 -->
                                                <div v-else
                                                    class="flex items-center gap-2 bg-white/20 p-2 rounded text-sm text-left">
                                                    <!-- 1. 图标防挤压 -->
                                                    <i class="fas fa-file-alt flex-shrink-0"></i>

                                                    <!-- 2. 删除 truncate，只保留 break-all -->
                                                    <span class="break-all leading-snug">[[ f.name ]]</span>
                                                </div>
                                            </div>
                                        </div>
                                        [[ msg.content ]]

                                        <!-- 【新增】解析内容的折叠面板 -->
                                        <details v-if="msg.parsed_context"
                                            class="mt-2 border-t border-white/20 pt-2 text-xs">
                                            <summary
                                                class="cursor-pointer font-medium hover:text-blue-100 select-none flex items-center gap-1 opacity-80">
                                                <i class="fas fa-file-alt"></i>
                                                <span>已解析文档内容 ([[ msg.parsed_context.length ]] 字符)</span>
                                            </summary>
                                            <div
                                                class="mt-2 p-2 bg-black/10 rounded font-mono break-all whitespace-pre-wrap max-h-40 overflow-y-auto">
                                                [[ msg.parsed_context ]]
                                            </div>
                                        </details>
                                    </div>

                                    <div v-else
                                        class="markdown-body dark:markdown-dark text-gray-800 dark:text-gray-200 bg-white dark:bg-darkinput px-4 py-2.5 rounded-2xl rounded-tl-sm border border-gray-200 dark:border-darkborder shadow-sm inline-block"
                                        v-html="renderContent(msg.content)"></div>
                                </div>
                            </div>

                            <!-- 底部操作栏 -->
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                                :class="msg.role === 'user' ? 'justify-end pr-14' : 'justify-start pl-14'">

                                <!-- 复制按钮 -->
                                <button @click="copyMessage(msg.content)" class="hover:text-blue-500 transition"
                                    title="复制">
                                    <i class="fas fa-copy"></i>
                                </button>

                                <!-- 编辑按钮 -->
                                <button @click="editMessage(index)" class="hover:text-blue-500 transition" title="编辑">
                                    <i class="fas fa-pen"></i>
                                </button>

                                <!-- 删除按钮 -->
                                <button @click="deleteMessage(index)" class="hover:text-red-500 transition" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>

                                <!-- 重新生成按钮 -->
                                <button v-if="msg.role !== 'user' && index === messages.length - 1 && !isThinking"
                                    @click="regenerateResponse(index)" class="hover:text-purple-500 transition"
                                    title="重新生成">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 思考中状态 -->
                        <div v-if="isThinking" class="max-w-4xl mx-auto flex flex-col items-start animate-pulse">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-9 h-9 rounded-full bg-white dark:bg-darkinput border dark:border-darkborder flex items-center justify-center p-1 shadow-sm ml-2">
                                    <img :src="getModelAvatar(settings.model)" class="w-full h-full object-contain">
                                </div>
                                <div class="text-gray-400 text-sm pt-2">[[ t('thinking') ]]</div>
                            </div>
                        </div>
                    </div>

                    <!-- 底部输入框 (聊天模式) -->
                    <div class="p-4 bg-white dark:bg-darkbg border-t dark:border-darkborder">
                        <div
                            class="max-w-3xl mx-auto relative border border-gray-300 dark:border-darkborder rounded-2xl bg-gray-50 dark:bg-darkinput focus-within:ring-2 focus-within:ring-blue-500 transition-all">

                            <div v-if="attachedFiles.length > 0" class="px-3 pt-2 flex gap-2 overflow-x-auto pb-1">
                                <div v-for="(file, idx) in attachedFiles" :key="idx"
                                    class="relative group flex-shrink-0 h-12 w-12 border dark:border-gray-600 rounded overflow-hidden">
                                    <img v-if="file.type==='image'" :src="file.content"
                                        class="h-full w-full object-cover">
                                    <div v-else
                                        class="h-full w-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                                        <i class="fas fa-file"></i>
                                    </div>
                                    <button @click="removeFile(idx)"
                                        class="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center">&times;</button>
                                </div>
                            </div>

                            <!-- 1. Textarea 增加 pb-10 留出底部空间 -->
                            <textarea v-model="inputMessage"
                                @keydown.enter.prevent="!isThinking && !isStreaming ? sendMessage() : null"
                                class="w-full py-3 pl-4 pr-12 pb-12 outline-none resize-none bg-transparent text-gray-700 dark:text-gray-200 max-h-32 min-h-[56px] custom-scrollbar"
                                placeholder="输入消息..." rows="1"></textarea>

                            <!-- 2. [新增] 左下角工具栏 (深度思考) -->
                            <div class="absolute bottom-2.5 left-3 flex items-center gap-2">
                                <button @click="toggleDeepThinking"
                                    class="flex items-center gap-1.5 px-3 py-1 rounded-full text-[11px] font-bold transition-all border select-none"
                                    :class="isDeepThinkingEnabled ? 
                    'bg-blue-100 text-blue-600 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-700/50' : 
                    'bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600'">
                                    <i class="fas fa-brain"></i>
                                    <span>[[ t('deep_think_btn') ]]</span>
                                </button>
                            </div>

                            <!-- 3. 右下角工具栏 (附件 + 发送) -->
                            <div class="absolute bottom-2 right-2 flex items-center space-x-2">
                                <button @click="triggerFileUpload"
                                    class="text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 p-2 transition rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <i class="fas fa-paperclip"></i>
                                </button>

                                <button @click="sendMessage" :disabled="isThinking || isStreaming"
                                    class="bg-blue-600 text-white rounded-lg w-8 h-8 flex items-center justify-center hover:bg-blue-700 disabled:opacity-50 shadow-md transition-transform active:scale-95">
                                    <i class="fas" :class="isStreaming ? 'fa-stop' : 'fa-arrow-up'"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 隐藏的文件输入框 -->
        <input type="file" id="file-input" multiple @change="handleFileSelect" class="hidden">
    </div>
    <script>
        // 使用 safe 过滤器防止 Jinja2 转义引号
        window.SHARED_MATCH_RULES = {{ rules_json | safe }};
    </script>

    <!-- 模块化脚本引用 -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/api.js"></script>
    <!-- 【新增】语言包必须在 app.js 之前 -->
    <script src="/static/js/locales.js"></script>
    <script src="/static/js/app.js"></script>

</body>

</html>